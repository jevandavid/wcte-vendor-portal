<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCTE Vendor Portal - Time Entry</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .body {
            padding: 40px 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin: 30px -30px 25px -30px;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .section-header:first-child {
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .required {
            color: #dc3545;
            margin-left: 3px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 50px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-add {
            background: #28a745;
        }
        
        .btn-remove {
            background: #dc3545;
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #0d47a1;
        }
        
        .calculation-box {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calculation-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.2em;
            color: #667eea;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #667eea;
        }
        
        .expense-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid #667eea;
        }
        
        .expense-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .file-upload-area {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background: #e8ebfc;
            border-color: #764ba2;
        }
        
        .file-upload-area input[type="file"] {
            display: none;
        }
        
        .uploaded-files {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #dee2e6;
        }
        
        .file-item-name {
            flex: 1;
            font-size: 0.9em;
            color: #333;
        }
        
        .file-item-size {
            color: #6c757d;
            font-size: 0.85em;
            margin-right: 10px;
        }
        
        .helper-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
        
        .alert {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .time-entry-fields {
            display: none;
        }
        
        .time-entry-fields.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .two-col {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .body {
                padding: 30px 20px;
            }
            
            .section-header {
                margin-left: -20px;
                margin-right: -20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WCTE Vendor Portal</h1>
            <p class="subtitle">Time Entry & Payment Management</p>
        </div>
        
        <div class="body">
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>
            <div id="alertWarning" class="alert alert-warning"></div>
            
            <div id="sectionLogin" class="section active">
                <div class="section-header">Vendor Login</div>
                
                <div class="info-box">
                    <p><strong>Welcome to the WCTE Vendor Portal</strong></p>
                    <p>Please enter your email address to access your time entry form.</p>
                </div>
                
                <div class="form-group">
                    <label for="vendorEmail">Your Email Address <span class="required">*</span></label>
                    <input type="email" id="vendorEmail" placeholder="your@email.com" required>
                    <p class="helper-text">Use the email address on file with WCTE</p>
                </div>
                
                <button class="btn" onclick="loginVendor()">Continue</button>
                
                <div id="loadingLogin" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Verifying your information...</p>
                </div>
            </div>
            
            <div id="sectionTimeEntry" class="section">
                <div class="section-header">Time Entry Form</div>
                
                <div id="vendorInfo" class="info-box">
                    <p><strong>Vendor:</strong> <span id="displayName"></span></p>
                    <p><strong>Pay Structure:</strong> <span id="displayPayType"></span></p>
                    <p><strong>Rate:</strong> <span id="displayRate"></span></p>
                </div>
                
                <form id="timeEntryForm">
                    <div class="section-header">Event Information</div>
                    
                    <div class="form-group">
                        <label for="eventDate">Date of Service <span class="required">*</span></label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventName">Competition/Event Name <span class="required">*</span></label>
                        <input type="text" id="eventName" name="eventName" placeholder="e.g., Worcester Regional Championship" required>
                    </div>
                    
                    <div class="two-col">
                        <div class="form-group">
                            <label for="eventLocation">Event Location <span class="required">*</span></label>
                            <input type="text" id="eventLocation" name="eventLocation" placeholder="City, State" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="rolePerformed">Role Performed <span class="required">*</span></label>
                            <select id="rolePerformed" name="rolePerformed" required>
                                <option value="">Select Role</option>
                                <option value="Judge">Judge</option>
                                <option value="Choreographer">Choreographer</option>
                                <option value="Instructor">Instructor</option>
                                <option value="Adjudicator">Adjudicator</option>
                                <option value="Staff">Staff</option>
                                <option value="Technical">Technical Staff</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Time Entry Fields (Hourly/Daily/Routine/Fixed) -->
                    <div id="hourlyFields" class="time-entry-fields">
                        <div class="section-header">Time Worked</div>
                        
                        <div class="two-col">
                            <div class="form-group">
                                <label for="clockIn">Clock In Time</label>
                                <input type="time" id="clockIn" name="clockIn">
                            </div>
                            
                            <div class="form-group">
                                <label for="clockOut">Clock Out Time</label>
                                <input type="time" id="clockOut" name="clockOut">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="breakMinutes">Break Time (minutes)</label>
                            <input type="number" id="breakMinutes" name="breakMinutes" value="0" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="hoursWorked">Total Hours Worked</label>
                            <input type="text" id="hoursWorked" readonly style="background: #f8f9fa; font-weight: 600;">
                        </div>
                    </div>
                    
                    <div id="dailyFields" class="time-entry-fields">
                        <div class="section-header">Daily Rate</div>
                        
                        <div class="form-group">
                            <label for="dayType">Day Type</label>
                            <select id="dayType" name="dayType">
                                <option value="">Select Type</option>
                                <option value="full">Full Day</option>
                                <option value="half">Half Day</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="routineFields" class="time-entry-fields">
                        <div class="section-header">Routine Count</div>
                        
                        <div class="form-group">
                            <label for="routineCount">Number of Routines</label>
                            <input type="number" id="routineCount" name="routineCount" min="0" step="1">
                        </div>
                    </div>
                    
                    <div id="fixedFields" class="time-entry-fields">
                        <div class="section-header">Fixed Payment</div>
                        
                        <div class="info-box">
                            <p><strong>Fixed Rate:</strong> <span id="fixedRateDisplay"></span></p>
                            <p>Your payment for this event is a set amount regardless of hours worked.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="confirmFixed" name="confirmFixed">
                                I confirm my attendance and work for this event
                            </label>
                        </div>
                    </div>
                    
                    <!-- NEW: Mileage Entries -->
                    <div class="section-header">Mileage Reimbursement</div>
                    
                    <div class="info-box">
                        <p><strong>Mileage Rate:</strong> $0.67 per mile</p>
                        <p>Add all trips related to this event (to/from venue, errands, etc.)</p>
                    </div>
                    
                    <div id="mileageEntries"></div>
                    
                    <button type="button" class="btn btn-add btn-small" onclick="addMileageEntry()">+ Add Mileage Entry</button>
                    
                    <!-- NEW: General Expenses -->
                    <div class="section-header">General Expenses</div>
                    
                    <div class="info-box">
                        <p>Add expenses such as meals, lodging, supplies, parking, etc.</p>
                    </div>
                    
                    <div id="expenseEntries"></div>
                    
                    <button type="button" class="btn btn-add btn-small" onclick="addExpenseEntry()">+ Add Expense</button>
                    
                    <!-- Receipt Upload -->
                    <div class="section-header">Receipt Upload</div>
                    
                    <div class="form-group">
                        <label for="receiptUpload">Upload Receipts (Optional)</label>
                        <div class="file-upload-area" onclick="document.getElementById('receiptUpload').click()">
                            <input type="file" id="receiptUpload" multiple accept="image/*,.pdf" onchange="handleFileSelect(event)">
                            <p>ðŸ“Ž Click to upload receipts</p>
                            <p class="helper-text">Images (JPG, PNG) or PDF files</p>
                        </div>
                        <div id="uploadedFiles" class="uploaded-files"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalNotes">Additional Notes</label>
                        <textarea id="additionalNotes" name="additionalNotes" placeholder="Any additional information"></textarea>
                    </div>
                    
                    <!-- Payment Calculation -->
                    <div class="calculation-box">
                        <h3 style="margin-bottom: 15px; color: #667eea;">Payment Calculation</h3>
                        
                        <div class="calculation-row">
                            <span>Base Pay:</span>
                            <span id="calcBasePay">$0.00</span>
                        </div>
                        
                        <div class="calculation-row" id="calcOvertimeRow" style="display: none;">
                            <span>Overtime Pay:</span>
                            <span id="calcOvertimePay">$0.00</span>
                        </div>
                        
                        <div class="calculation-row">
                            <span>Mileage:</span>
                            <span id="calcMileage">$0.00</span>
                        </div>
                        
                        <div class="calculation-row">
                            <span>Expenses:</span>
                            <span id="calcExpenses">$0.00</span>
                        </div>
                        
                        <div class="calculation-row">
                            <span>TOTAL GROSS PAY:</span>
                            <span id="calcTotal">$0.00</span>
                        </div>
                    </div>
                    
                    <!-- Acknowledgment -->
                    <div class="info-box" style="background: #fff3cd; border-color: #ffc107;">
                        <p style="color: #856404;"><strong>Acknowledgment:</strong></p>
                        <p style="color: #856404;">By submitting this form, I certify that all information provided is accurate and truthful.</p>
                        <div style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="acknowledge" name="acknowledge" required>
                                <strong>I acknowledge and certify the above information is correct</strong> <span class="required">*</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="logout()">Back to Login</button>
                        <button type="submit" class="btn">Submit Time Entry</button>
                    </div>
                </form>
                
                <div id="loadingSubmit" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Submitting your time entry...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
const EMAILJS_PUBLIC_KEY = '3hfbTN_SU-93VXhYt';
const EMAILJS_SERVICE_ID = 'service_o8fi71j';
const EMAILJS_TEMPLATE_OFFICE = 'template_1tfz67w';
const EMAILJS_TEMPLATE_CONFIRMATION = 'template_x7fzk5a';
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbz9L9HpPFYqFUeLvJeZ4MmeALiiE4zPdIRcKLAGWPyh8-YvFJz8V43aJ2Nh-4VWYKyt/exec';

emailjs.init(EMAILJS_PUBLIC_KEY);

let currentVendor = null;
let vendorsList = [];
let mileageEntries = [];
let expenseEntries = [];
let uploadedFiles = [];

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('eventDate').valueAsDate = new Date();
    setupCalculationListeners();
    loadVendors();
    
    // Add initial entries
    addMileageEntry();
    addExpenseEntry();
});

async function loadVendors() {
    try {
        const response = await fetch(`${WEBAPP_URL}?action=getVendors`);
        const data = await response.json();
        vendorsList = data.vendors;
        console.log('Vendors loaded:', vendorsList.length);
    } catch (error) {
        console.error('Error loading vendors:', error);
        showAlert('error', 'Failed to load vendor data. Please refresh or contact office@wctedance.com');
    }
}

async function loginVendor() {
    const email = document.getElementById('vendorEmail').value.trim().toLowerCase();
    if (!email) {
        showAlert('warning', 'Please enter your email address.');
        return;
    }
    
    document.getElementById('loadingLogin').style.display = 'block';
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const vendor = vendorsList.find(v => v.email.toLowerCase() === email);
    document.getElementById('loadingLogin').style.display = 'none';
    
    if (vendor) {
        currentVendor = vendor;
        showTimeEntryForm();
    } else {
        showAlert('error', 'Email not found. Please contact office@wctedance.com');
    }
}

function logout() {
    currentVendor = null;
    document.getElementById('timeEntryForm').reset();
    document.getElementById('eventDate').valueAsDate = new Date();
    mileageEntries = [];
    expenseEntries = [];
    uploadedFiles = [];
    hideAllAlerts();
    showSection('sectionLogin');
}

function showTimeEntryForm() {
    document.getElementById('displayName').textContent = `${currentVendor.firstName} ${currentVendor.lastName}`;
    document.getElementById('displayPayType').textContent = getPayTypeDisplay(currentVendor.payType);
    document.getElementById('displayRate').textContent = getRateDisplay(currentVendor);
    
    hideAllTimeEntryFields();
    
    document.getElementById('clockIn').required = false;
    document.getElementById('clockOut').required = false;
    document.getElementById('dayType').required = false;
    document.getElementById('routineCount').required = false;
    document.getElementById('confirmFixed').required = false;
    
    switch(currentVendor.payType) {
        case 'hourly':
            document.getElementById('hourlyFields').classList.add('show');
            document.getElementById('clockIn').required = true;
            document.getElementById('clockOut').required = true;
            break;
        case 'daily':
            document.getElementById('dailyFields').classList.add('show');
            document.getElementById('dayType').required = true;
            break;
        case 'routine':
            document.getElementById('routineFields').classList.add('show');
            document.getElementById('routineCount').required = true;
            break;
        case 'fixed':
            document.getElementById('fixedFields').classList.add('show');
            document.getElementById('fixedRateDisplay').textContent = `$${currentVendor.fixedAmount.toFixed(2)}`;
            document.getElementById('confirmFixed').required = true;
            break;
    }
    
    showSection('sectionTimeEntry');
    calculatePayment();
}

function hideAllTimeEntryFields() {
    document.querySelectorAll('.time-entry-fields').forEach(el => {
        el.classList.remove('show');
    });
}

function getPayTypeDisplay(type) {
    const types = {'hourly': 'Hourly Rate', 'daily': 'Daily Rate', 'routine': 'Per-Routine', 'fixed': 'Fixed Amount'};
    return types[type] || type;
}

function getRateDisplay(vendor) {
    switch(vendor.payType) {
        case 'hourly':
            return `$${vendor.hourlyRate}/hr${vendor.overtimeEligible ? ' (OT after ' + vendor.overtimeThreshold + ' hrs)' : ''}`;
        case 'daily':
            return `Full: $${vendor.fullDayRate} | Half: $${vendor.halfDayRate}`;
        case 'routine':
            return `$${vendor.perRoutineRate}/routine`;
        case 'fixed':
            return `$${vendor.fixedAmount} per event`;
        default:
            return 'N/A';
    }
}

// NEW: Mileage Entry Management
function addMileageEntry() {
    const id = Date.now();
    mileageEntries.push({ id, date: '', miles: 0 });
    renderMileageEntries();
}

function removeMileageEntry(id) {
    mileageEntries = mileageEntries.filter(e => e.id !== id);
    renderMileageEntries();
    calculatePayment();
}

function renderMileageEntries() {
    const container = document.getElementById('mileageEntries');
    container.innerHTML = mileageEntries.map((entry, index) => `
        <div class="expense-entry">
            <div class="expense-entry-header">
                <strong>Trip ${index + 1}</strong>
                ${mileageEntries.length > 1 ? `<button type="button" class="btn btn-remove" onclick="removeMileageEntry(${entry.id})">Remove</button>` : ''}
            </div>
            <div class="two-col">
                <div>
                    <label>Date</label>
                    <input type="date" value="${entry.date}" onchange="updateMileageEntry(${entry.id}, 'date', this.value)">
                </div>
                <div>
                    <label>Miles</label>
                    <input type="number" step="0.1" min="0" value="${entry.miles}" onchange="updateMileageEntry(${entry.id}, 'miles', this.value)" placeholder="0.0">
                </div>
            </div>
            <p class="helper-text">Reimbursement: $${(entry.miles * 0.67).toFixed(2)}</p>
        </div>
    `).join('');
}

function updateMileageEntry(id, field, value) {
    const entry = mileageEntries.find(e => e.id === id);
    if (entry) {
        entry[field] = field === 'miles' ? parseFloat(value) || 0 : value;
        renderMileageEntries();
        calculatePayment();
    }
}

// NEW: General Expense Entry Management
function addExpenseEntry() {
    const id = Date.now();
    expenseEntries.push({ id, date: '', amount: 0, description: '' });
    renderExpenseEntries();
}

function removeExpenseEntry(id) {
    expenseEntries = expenseEntries.filter(e => e.id !== id);
    renderExpenseEntries();
    calculatePayment();
}

function renderExpenseEntries() {
    const container = document.getElementById('expenseEntries');
    container.innerHTML = expenseEntries.map((entry, index) => `
        <div class="expense-entry">
            <div class="expense-entry-header">
                <strong>Expense ${index + 1}</strong>
                ${expenseEntries.length > 1 ? `<button type="button" class="btn btn-remove" onclick="removeExpenseEntry(${entry.id})">Remove</button>` : ''}
            </div>
            <div class="two-col">
                <div>
                    <label>Date</label>
                    <input type="date" value="${entry.date}" onchange="updateExpenseEntry(${entry.id}, 'date', this.value)">
                </div>
                <div>
                    <label>Amount</label>
                    <input type="number" step="0.01" min="0" value="${entry.amount}" onchange="updateExpenseEntry(${entry.id}, 'amount', this.value)" placeholder="0.00">
                </div>
            </div>
            <div>
                <label>Description</label>
                <input type="text" value="${entry.description}" onchange="updateExpenseEntry(${entry.id}, 'description', this.value)" placeholder="e.g., Hotel, Meals, Parking">
            </div>
        </div>
    `).join('');
}

function updateExpenseEntry(id, field, value) {
    const entry = expenseEntries.find(e => e.id === id);
    if (entry) {
        entry[field] = field === 'amount' ? parseFloat(value) || 0 : value;
        renderExpenseEntries();
        calculatePayment();
    }
}

// NEW: File Upload Handling
function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    
    files.forEach(file => {
        if (file.size > 5 * 1024 * 1024) {
            showAlert('warning', `File "${file.name}" is too large. Maximum 5MB per file.`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedFiles.push({
                name: file.name,
                size: file.size,
                type: file.type,
                data: e.target.result
            });
            renderUploadedFiles();
        };
        reader.readAsDataURL(file);
    });
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    renderUploadedFiles();
}

function renderUploadedFiles() {
    const container = document.getElementById('uploadedFiles');
    if (uploadedFiles.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-item">
            <span class="file-item-name">ðŸ“„ ${file.name}</span>
            <span class="file-item-size">${(file.size / 1024).toFixed(1)} KB</span>
            <button type="button" class="btn btn-remove" onclick="removeFile(${index})">Remove</button>
        </div>
    `).join('');
}

function setupCalculationListeners() {
    ['clockIn', 'clockOut', 'breakMinutes', 'dayType', 'routineCount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener(el.type === 'number' ? 'input' : 'change', calculatePayment);
    });
}

function calculatePayment() {
    if (!currentVendor) return;
    
    let basePay = 0, overtimePay = 0;
    
    switch(currentVendor.payType) {
        case 'hourly':
            const result = calculateHourlyPay();
            basePay = result.basePay;
            overtimePay = result.overtimePay;
            document.getElementById('hoursWorked').value = (result.regularHours + result.overtimeHours).toFixed(2) + ' hours';
            break;
        case 'daily':
            basePay = calculateDailyPay();
            break;
        case 'routine':
            basePay = calculateRoutinePay();
            break;
        case 'fixed':
            basePay = currentVendor.fixedAmount;
            break;
    }
    
    const mileageTotal = mileageEntries.reduce((sum, e) => sum + (e.miles * 0.67), 0);
    const expensesTotal = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
    
    document.getElementById('calcBasePay').textContent = `$${basePay.toFixed(2)}`;
    
    if (overtimePay > 0) {
        document.getElementById('calcOvertimeRow').style.display = 'flex';
        document.getElementById('calcOvertimePay').textContent = `$${overtimePay.toFixed(2)}`;
    } else {
        document.getElementById('calcOvertimeRow').style.display = 'none';
    }
    
    document.getElementById('calcMileage').textContent = `$${mileageTotal.toFixed(2)}`;
    document.getElementById('calcExpenses').textContent = `$${expensesTotal.toFixed(2)}`;
    document.getElementById('calcTotal').textContent = `$${(basePay + overtimePay + mileageTotal + expensesTotal).toFixed(2)}`;
}

function calculateHourlyPay() {
    const clockIn = document.getElementById('clockIn').value;
    const clockOut = document.getElementById('clockOut').value;
    const breakMinutes = parseFloat(document.getElementById('breakMinutes').value) || 0;
    
    if (!clockIn || !clockOut) return { basePay: 0, overtimePay: 0, regularHours: 0, overtimeHours: 0 };
    
    const start = new Date(`2000-01-01T${clockIn}`);
    const end = new Date(`2000-01-01T${clockOut}`);
    let totalMinutes = (end - start) / (1000 * 60);
    if (totalMinutes < 0) totalMinutes += 24 * 60;
    totalMinutes -= breakMinutes;
    const totalHours = Math.max(0, totalMinutes / 60);
    
    let regularHours = totalHours, overtimeHours = 0, basePay = 0, overtimePay = 0;
    
    if (currentVendor.overtimeEligible && totalHours > currentVendor.overtimeThreshold) {
        regularHours = currentVendor.overtimeThreshold;
        overtimeHours = totalHours - currentVendor.overtimeThreshold;
        basePay = regularHours * currentVendor.hourlyRate;
        overtimePay = overtimeHours * currentVendor.hourlyRate * currentVendor.overtimeMultiplier;
    } else {
        basePay = totalHours * currentVendor.hourlyRate;
    }
    
    return { basePay, overtimePay, regularHours, overtimeHours };
}

function calculateDailyPay() {
    const dayType = document.getElementById('dayType').value;
    return dayType === 'full' ? currentVendor.fullDayRate : dayType === 'half' ? currentVendor.halfDayRate : 0;
}

function calculateRoutinePay() {
    const routineCount = parseFloat(document.getElementById('routineCount').value) || 0;
    return routineCount * currentVendor.perRoutineRate;
}

document.getElementById('timeEntryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentVendor) {
        showAlert('error', 'Session expired. Please log in again.');
        logout();
        return;
    }
    
    if (!document.getElementById('acknowledge').checked) {
        showAlert('warning', 'Please acknowledge that all information is correct.');
        return;
    }
    
    document.getElementById('loadingSubmit').style.display = 'block';
    hideAllAlerts();
    
    try {
        const formData = collectFormData();
        const result = await submitToWebApp(formData);
        await sendEmailNotifications(formData);
        
        document.getElementById('loadingSubmit').style.display = 'none';
        
        let successMsg = 'Time entry submitted successfully! You will receive a confirmation email at ' + formData.vendorEmail;
        if (result.driveFolder) {
            successMsg += '\n\nReceipts uploaded to: ' + result.driveFolder;
        }
        showAlert('success', successMsg);
        
        setTimeout(() => {
            document.getElementById('timeEntryForm').reset();
            document.getElementById('eventDate').valueAsDate = new Date();
            mileageEntries = [];
            expenseEntries = [];
            uploadedFiles = [];
            addMileageEntry();
            addExpenseEntry();
            calculatePayment();
            hideAllAlerts();
        }, 3000);
        
    } catch (error) {
        document.getElementById('loadingSubmit').style.display = 'none';
        console.error('Submission error:', error);
        showAlert('error', 'Failed to submit. Please try again or contact office@wctedance.com');
    }
});

function collectFormData() {
    const form = document.getElementById('timeEntryForm');
    const formData = new FormData(form);
    
    let basePay = 0, overtimePay = 0, details = '';
    
    switch(currentVendor.payType) {
        case 'hourly':
            const hourlyResult = calculateHourlyPay();
            basePay = hourlyResult.basePay;
            overtimePay = hourlyResult.overtimePay;
            details = `Hours: ${(hourlyResult.regularHours + hourlyResult.overtimeHours).toFixed(2)}`;
            break;
        case 'daily':
            basePay = calculateDailyPay();
            details = `Day Type: ${formData.get('dayType')}`;
            break;
        case 'routine':
            basePay = calculateRoutinePay();
            details = `Routines: ${formData.get('routineCount')}`;
            break;
        case 'fixed':
            basePay = currentVendor.fixedAmount;
            details = 'Fixed Amount';
            break;
    }
    
    const mileageTotal = mileageEntries.reduce((sum, e) => sum + (e.miles * 0.67), 0);
    const expensesTotal = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
    const totalPay = basePay + overtimePay + mileageTotal + expensesTotal;
    
    return {
        vendorId: currentVendor.id,
        vendorName: `${currentVendor.firstName} ${currentVendor.lastName}`,
        vendorEmail: currentVendor.email,
        payType: currentVendor.payType,
        eventDate: formData.get('eventDate'),
        eventName: formData.get('eventName'),
        eventLocation: formData.get('eventLocation'),
        rolePerformed: formData.get('rolePerformed'),
        workDetails: details,
        clockIn: formData.get('clockIn') || 'N/A',
        clockOut: formData.get('clockOut') || 'N/A',
        breakMinutes: formData.get('breakMinutes') || '0',
        dayType: formData.get('dayType') || 'N/A',
        routineCount: formData.get('routineCount') || '0',
        mileageEntries: JSON.stringify(mileageEntries),
        mileageTotal: mileageTotal.toFixed(2),
        expenseEntries: JSON.stringify(expenseEntries),
        expensesTotal: expensesTotal.toFixed(2),
        receipts: JSON.stringify(uploadedFiles.map(f => ({ name: f.name, size: f.size, type: f.type }))),
        receiptFiles: uploadedFiles.length > 0 ? JSON.stringify(uploadedFiles) : '',
        basePay: basePay.toFixed(2),
        overtimePay: overtimePay.toFixed(2),
        totalPay: totalPay.toFixed(2),
        additionalNotes: formData.get('additionalNotes') || '',
        submissionDate: new Date().toISOString(),
        status: 'Pending Review'
    };
}

async function submitToWebApp(data) {
    const response = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain'},
        body: JSON.stringify({action: 'submitTimeEntry', data: data})
    });
    
    if (!response.ok) throw new Error('Failed to submit');
    return await response.json();
}

async function sendEmailNotifications(data) {
    const mileageDetails = mileageEntries.map((e, i) => 
        `Trip ${i+1}: ${e.date || 'No date'} - ${e.miles} miles = $${(e.miles * 0.67).toFixed(2)}`
    ).join('\n');
    
    const expenseDetails = expenseEntries.map((e, i) => 
        `Expense ${i+1}: ${e.date || 'No date'} - ${e.description || 'No description'} = $${e.amount.toFixed(2)}`
    ).join('\n');
    
    const officeEmail = `WCTE TIME ENTRY
Vendor: ${data.vendorName}
Event: ${data.eventName} (${data.eventDate})
Location: ${data.eventLocation}
Role: ${data.rolePerformed}
Work: ${data.workDetails}

PAYMENT:
Base Pay: $${data.basePay}
OT Pay: $${data.overtimePay}
Mileage: $${data.mileageTotal}
${mileageDetails}
Expenses: $${data.expensesTotal}
${expenseDetails}
TOTAL: $${data.totalPay}

Receipts: ${uploadedFiles.length} file(s) attached`;
    
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_OFFICE, {
        from_name: data.vendorName,
        from_email: data.vendorEmail,
        subject: `Time Entry - ${data.vendorName} - ${data.eventName}`,
        message: officeEmail,
        to_email: 'office@wctedance.com'
    });
    
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CONFIRMATION, {
        to_email: data.vendorEmail,
        vendor_name: data.vendorName,
        event_name: data.eventName,
        event_date: data.eventDate,
        total_amount: data.totalPay
    });
}

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
}

function showAlert(type, message) {
    hideAllAlerts();
    const alertId = type === 'success' ? 'alertSuccess' : type === 'error' ? 'alertError' : 'alertWarning';
    const alertEl = document.getElementById(alertId);
    alertEl.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
    alertEl.classList.add('show');
    alertEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideAllAlerts() {
    document.querySelectorAll('.alert').forEach(alert => alert.classList.remove('show'));
}
    </script>
</body>
</html>
