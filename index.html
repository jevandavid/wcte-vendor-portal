<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCTE Vendor Portal - Time Entry</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .body {
            padding: 40px 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin: 30px -30px 25px -30px;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .section-header:first-child {
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .required {
            color: #dc3545;
            margin-left: 3px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 50px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-add {
            background: #28a745;
        }
        
        .btn-remove {
            background: #dc3545;
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #0d47a1;
        }
        
        .calculation-box {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calculation-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.2em;
            color: #667eea;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #667eea;
        }
        
        .expense-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid #667eea;
        }
        
        .expense-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .file-upload-area {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background: #e8ebfc;
            border-color: #764ba2;
        }
        
        .file-upload-area input[type="file"] {
            display: none;
        }
        
        .uploaded-files {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #dee2e6;
        }
        
        .file-item-name {
            flex: 1;
            font-size: 0.9em;
            color: #333;
        }
        
        .file-item-size {
            color: #6c757d;
            font-size: 0.85em;
            margin-right: 10px;
        }
        
        .helper-text {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
        
        .alert {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .time-entry-fields {
            display: none;
        }
        
        .time-entry-fields.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .two-col {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .body {
                padding: 30px 20px;
            }
            
            .section-header {
                margin-left: -20px;
                margin-right: -20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WCTE Vendor Portal</h1>
            <p class="subtitle">Time Entry & Payment Management</p>
        </div>
        
        <div class="body">
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>
            <div id="alertWarning" class="alert alert-warning"></div>
            
            <div id="sectionLogin" class="section active">
                <div class="section-header">Vendor Login</div>
                
                <div class="info-box">
                    <p><strong>Welcome to the WCTE Vendor Portal</strong></p>
                    <p>Please enter your email address to access your time entry form.</p>
                </div>
                
                <div class="form-group">
                    <label for="vendorEmail">Your Email Address <span class="required">*</span></label>
                    <input type="email" id="vendorEmail" placeholder="your@email.com" required>
                    <p class="helper-text">Use the email address on file with WCTE</p>
                </div>
                
                <button class="btn" onclick="loginVendor()">Continue</button>
                
                <div id="loadingLogin" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Verifying your information...</p>
                </div>
            </div>
            
            <div id="sectionTimeEntry" class="section">
                <div class="section-header">Time Entry Form</div>
                
                <div id="vendorInfo" class="info-box">
                    <p><strong>Vendor:</strong> <span id="displayName"></span></p>
                    <p><strong>Pay Structure:</strong> <span id="displayPayType"></span></p>
                    <p><strong>Rate:</strong> <span id="displayRate"></span></p>
                </div>
                
                <form id="timeEntryForm">
                    <!-- V3: FORM MODE SELECTOR -->
                    <div class="form-section" style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">ðŸ“‹ Submission Type</h3>
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 8px;">
                            <label style="display: flex; align-items: flex-start; margin-bottom: 20px; cursor: pointer; padding: 15px; background: white; border-radius: 6px; border: 2px solid #dee2e6; transition: border-color 0.3s;">
                                <input type="radio" name="submissionType" value="time_and_expenses" checked 
                                       onchange="toggleFormMode()" 
                                       style="margin-right: 12px; margin-top: 3px; width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #667eea; margin-bottom: 5px;">
                                        â° Time Entry + Expenses
                                    </div>
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        Track hours worked for one or more days and submit expenses
                                    </div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 15px; background: white; border-radius: 6px; border: 2px solid #dee2e6; transition: border-color 0.3s;">
                                <input type="radio" name="submissionType" value="expenses_only" 
                                       onchange="toggleFormMode()" 
                                       style="margin-right: 12px; margin-top: 3px; width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #ff6b6b; margin-bottom: 5px;">
                                        ðŸ’° Expense Reporting Only
                                    </div>
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        Submit mileage and expenses without time tracking
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="section-header">Event Information</div>
                    
                    <div class="form-group">
                        <label for="eventDate">Date of Service <span class="required">*</span></label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventName">Competition/Event Name <span class="required">*</span></label>
                        <input type="text" id="eventName" name="eventName" placeholder="e.g., Worcester Regional Championship" required>
                    </div>
                    
                    <div class="two-col">
                        <div class="form-group">
                            <label for="eventLocation">Event Location <span class="required">*</span></label>
                            <input type="text" id="eventLocation" name="eventLocation" placeholder="City, State" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="rolePerformed">Role Performed <span class="required">*</span></label>
                            <select id="rolePerformed" name="rolePerformed" required>
                                <option value="">Select Role</option>
                                <option value="Judge">Judge</option>
                                <option value="Choreographer">Choreographer</option>
                                <option value="Instructor">Instructor</option>
                                <option value="Adjudicator">Adjudicator</option>
                                <option value="Staff">Staff</option>
                                <option value="Technical">Technical Staff</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Time Entry Fields (Hourly/Daily/Routine/Fixed) -->
                    <div id="hourlyFields" class="time-entry-fields">
                        <div class="section-header">Time Worked</div>
                        
                        <div class="two-col">
                            <div class="form-group">
                                <label for="clockIn">Clock In Time</label>
                                <input type="time" id="clockIn" name="clockIn">
                            </div>
                            
                            <div class="form-group">
                                <label for="clockOut">Clock Out Time</label>
                                <input type="time" id="clockOut" name="clockOut">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="breakMinutes">Break Time (minutes)</label>
                            <input type="number" id="breakMinutes" name="breakMinutes" value="0" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="hoursWorked">Total Hours Worked</label>
                            <input type="text" id="hoursWorked" readonly style="background: #f8f9fa; font-weight: 600;">
                        </div>
                    </div>
                    
                    <div id="dailyFields" class="time-entry-fields">
                        <div class="section-header">Daily Rate</div>
                        
                        <div class="form-group">
                            <label for="dayType">Day Type</label>
                            <select id="dayType" name="dayType">
                                <option value="">Select Type</option>
                                <option value="full">Full Day</option>
                                <option value="half">Half Day</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="routineFields" class="time-entry-fields">
                        <div class="section-header">Routine Count</div>
                        
                        <div class="form-group">
                            <label for="routineCount">Number of Routines</label>
                            <input type="number" id="routineCount" name="routineCount" min="0" step="1">
                        </div>
                    </div>
                    
                    <div id="fixedFields" class="time-entry-fields">
                        <div class="section-header">Fixed Payment</div>
                        
                        <div class="info-box">
                            <p><strong>Fixed Rate:</strong> <span id="fixedRateDisplay"></span></p>
                            <p>Your payment for this event is a set amount regardless of hours worked.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="confirmFixed" name="confirmFixed">
                                I confirm my attendance and work for this event
                            </label>
                        </div>
                    </div>
                    
                    
                    <!-- V3: MULTIPLE TIME ENTRIES SECTION -->
                    <div id="timeEntrySection" class="form-section" style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin: 0;">â° Time Entry Details</h3>
                            <button type="button" onclick="addTimeEntry()" class="btn" 
                                    style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                + Add Day
                            </button>
                        </div>
                        
                        <div id="timeEntriesContainer" style="margin-bottom: 20px;">
                            <!-- Time entry cards will render here by JavaScript -->
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: right;">
                            <div style="font-size: 0.9em; margin-bottom: 5px;">Total Time Entry Pay</div>
                            <div style="font-size: 2em; font-weight: 700;" id="timeEntriesTotal">$0.00</div>
                        </div>
                    </div>
                    <!-- END V3 MULTIPLE TIME ENTRIES -->

                    
                    <!-- NEW: Mileage Entries -->
                    <div class="section-header">Mileage Reimbursement</div>
                    
                    <div class="info-box">
                        <p><strong>Mileage Rate:</strong> $0.67 per mile</p>
                        <p>Add all trips related to this event (to/from venue, errands, etc.)</p>
                    </div>
                    
                    <div id="mileageEntries"></div>
                    
                    <button type="button" class="btn btn-add btn-small" onclick="addMileageEntry()">+ Add Mileage Entry</button>
                    
                    <!-- NEW: General Expenses -->
                    <div class="section-header">General Expenses</div>
                    
                    <div class="info-box">
                        <p>Add expenses such as meals, lodging, supplies, parking, etc.</p>
                    </div>
                    
                    <div id="expenseEntries"></div>
                    
                    <button type="button" class="btn btn-add btn-small" onclick="addExpenseEntry()">+ Add Expense</button>
                    
                    <!-- Receipt Upload -->
                    <div class="section-header">Receipt Upload</div>
                    
                    <div class="form-group">
                        <label for="receiptUpload">Upload Receipts (Optional)</label>
                        <div class="file-upload-area" onclick="document.getElementById('receiptUpload').click()">
                            <input type="file" id="receiptUpload" multiple accept="image/*,.pdf" onchange="handleFileSelect(event)">
                            <p>ðŸ“Ž Click to upload receipts</p>
                            <p class="helper-text">Images (JPG, PNG) or PDF files</p>
                        </div>
                        <div id="uploadedFiles" class="uploaded-files"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalNotes">Additional Notes</label>
                        <textarea id="additionalNotes" name="additionalNotes" placeholder="Any additional information"></textarea>
                    </div>
                    
                    <!-- Payment Calculation -->
                    <div class="calculation-box">
                        <h3 style="margin-bottom: 15px; color: #667eea;">Payment Calculation</h3>
                        
                        <div class="calculation-row">
                            <span>Base Pay:</span>
                            <span id="calcBasePay">$0.00</span>
                        </div>
                        
                        <div class="calculation-row" id="calcOvertimeRow" style="display: none;">
                            <span>Overtime Pay:</span>
                            <span id="calcOvertimePay">$0.00</span>
                        </div>
                        
                        <div class="calculation-row">
                            <span>Mileage:</span>
                            <span id="calcMileage">$0.00</span>
                        </div>
                        
                        <div class="calculation-row">
                            <span>Expenses:</span>
                            <span id="calcExpenses">$0.00</span>
                        </div>
                        
                        <div class="calculation-row">
                            <span>TOTAL GROSS PAY:</span>
                            <span id="calcTotal">$0.00</span>
                        </div>
                    </div>
                    
                    <!-- Acknowledgment -->
                    <div class="info-box" style="background: #fff3cd; border-color: #ffc107;">
                        <p style="color: #856404;"><strong>Acknowledgment:</strong></p>
                        <p style="color: #856404;">By submitting this form, I certify that all information provided is accurate and truthful.</p>
                        <div style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="acknowledge" name="acknowledge" required>
                                <strong>I acknowledge and certify the above information is correct</strong> <span class="required">*</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="logout()">Back to Login</button>
                        <button type="submit" class="btn">Submit Time Entry</button>
                    </div>
                </form>
                
                <div id="loadingSubmit" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Submitting your time entry...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
const EMAILJS_PUBLIC_KEY = '3hfbTN_SU-93VXhYt';
const EMAILJS_SERVICE_ID = 'service_o8fi71j';
const EMAILJS_TEMPLATE_OFFICE = 'template_1tfz67w';
const EMAILJS_TEMPLATE_CONFIRMATION = 'template_x7fzk5a';
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbz9L9HpPFYqFUeLvJeZ4MmeALiiE4zPdIRcKLAGWPyh8-YvFJz8V43aJ2Nh-4VWYKyt/exec';

emailjs.init(EMAILJS_PUBLIC_KEY);

let currentVendor = null;
let vendorsList = [];
let mileageEntries = [];
let expenseEntries = [];
    // ============================================
    // V3: MULTIPLE TIME ENTRIES MANAGEMENT
    // ============================================
    
    let timeEntries = [];
    let timeEntryIdCounter = 1;

    function toggleFormMode() {
        const mode = document.querySelector('input[name="submissionType"]:checked').value;
        const timeSection = document.getElementById('timeEntrySection');
        
        if (mode === 'expenses_only') {
            timeSection.style.display = 'none';
            timeEntries = [];
            
            // Remove 'required' attribute from all time entry inputs when hidden
            const timeInputs = timeSection.querySelectorAll('input[required], select[required]');
            timeInputs.forEach(input => {
                input.removeAttribute('required');
                input.dataset.wasRequired = 'true'; // Mark for restoration later
            });
        } else {
            timeSection.style.display = 'block';
            if (timeEntries.length === 0) {
                addTimeEntry();
            }
            
            // Restore 'required' attribute to time entry inputs (will be re-added by renderTimeEntries)
            // The renderTimeEntries function will add required attributes back
        }
        calculatePayment();
    }

    function addTimeEntry() {
        const eventDateField = document.getElementById('eventDate');
        const entry = {
            id: timeEntryIdCounter++,
            date: eventDateField ? eventDateField.value : '',
            clockIn: '',
            clockOut: '',
            breakMinutes: 0,
            dayType: '',
            routineCount: 1,
            rolePerformed: '',
            workDetails: '',
            basePay: 0,
            overtimePay: 0
        };
        
        timeEntries.push(entry);
        renderTimeEntries();
        calculatePayment();
    }

    function removeTimeEntry(id) {
        if (timeEntries.length <= 1) {
            alert('You must have at least one time entry');
            return;
        }
        timeEntries = timeEntries.filter(e => e.id !== id);
        renderTimeEntries();
        calculatePayment();
    }

    function updateTimeEntry(id, field, value) {
        const entry = timeEntries.find(e => e.id === id);
        if (entry) {
            entry[field] = (field === 'breakMinutes' || field === 'routineCount') ? 
                           parseInt(value) || 0 : value;
        }
    }

    function renderTimeEntries() {
        const container = document.getElementById('timeEntriesContainer');
        if (!container || !currentVendor) return;
        
        // Check current submission mode - don't add 'required' if in expenses_only mode
        const mode = document.querySelector('input[name="submissionType"]:checked')?.value || 'time_and_expenses';
        const shouldRequire = mode === 'time_and_expenses' ? 'required' : '';
        
        container.innerHTML = timeEntries.map((entry, index) => {
            const canRemove = timeEntries.length > 1;
            
            return `
            <div class="entry-card" style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin: 0;">Day ${index + 1}</h4>
                    ${canRemove ? `
                        <button type="button" onclick="removeTimeEntry(${entry.id})" 
                                style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            × Remove
                        </button>
                    ` : ''}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date *</label>
                    <input type="date" value="${entry.date}" 
                           onchange="updateTimeEntry(${entry.id}, 'date', this.value); calculatePayment();"
                           style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;"
                           ${shouldRequire}>
                </div>
                
                ${currentVendor.payType === 'hourly' ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Clock In *</label>
                            <input type="time" value="${entry.clockIn}" 
                                   onchange="updateTimeEntry(${entry.id}, 'clockIn', this.value); calculatePayment();"
                                   style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;"
                                   ${shouldRequire}>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Clock Out *</label>
                            <input type="time" value="${entry.clockOut}" 
                                   onchange="updateTimeEntry(${entry.id}, 'clockOut', this.value); calculatePayment();"
                                   style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;"
                                   ${shouldRequire}>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Break (min)</label>
                            <input type="number" value="${entry.breakMinutes}" min="0" 
                                   onchange="updateTimeEntry(${entry.id}, 'breakMinutes', this.value); calculatePayment();"
                                   style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;">
                        </div>
                    </div>
                ` : ''}
                
                ${currentVendor.payType === 'daily' ? `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Day Type *</label>
                        <select onchange="updateTimeEntry(${entry.id}, 'dayType', this.value); calculatePayment();"
                                style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;"
                                ${shouldRequire}>
                            <option value="">Select...</option>
                            <option value="full" ${entry.dayType === 'full' ? 'selected' : ''}>Full Day</option>
                            <option value="half" ${entry.dayType === 'half' ? 'selected' : ''}>Half Day</option>
                        </select>
                    </div>
                ` : ''}
                
                ${currentVendor.payType === 'routine' ? `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Number of Routines *</label>
                        <input type="number" value="${entry.routineCount}" min="1" 
                               onchange="updateTimeEntry(${entry.id}, 'routineCount', this.value); calculatePayment();"
                               style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;"
                               ${shouldRequire}>
                    </div>
                ` : ''}
                
                <div style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); padding: 15px; border-radius: 6px; text-align: right;">
                    <strong style="color: #667eea;">This Day's Pay: $${(entry.basePay + entry.overtimePay).toFixed(2)}</strong>
                </div>
            </div>
            `;
        }).join('');
    }

    function calculateHourlyPayForEntry(entry) {
        if (!entry.clockIn || !entry.clockOut) {
            return { basePay: 0, overtimePay: 0 };
        }
        
        const clockIn = new Date(`2000-01-01T${entry.clockIn}`);
        const clockOut = new Date(`2000-01-01T${entry.clockOut}`);
        const totalMinutes = (clockOut - clockIn) / 60000;
        const workMinutes = totalMinutes - (entry.breakMinutes || 0);
        const workHours = workMinutes / 60;
        
        let regularHours = workHours;
        let overtimeHours = 0;
        
        if (currentVendor.overtimeEligible && workHours > currentVendor.overtimeThreshold) {
            regularHours = currentVendor.overtimeThreshold;
            overtimeHours = workHours - currentVendor.overtimeThreshold;
        }
        
        const basePay = regularHours * currentVendor.hourlyRate;
        const overtimePay = overtimeHours * currentVendor.hourlyRate * currentVendor.overtimeMultiplier;
        
        return { basePay, overtimePay };
    }

    // V3: Updated calculatePayment to handle multiple time entries
    calculatePayment = function() {
        if (!currentVendor) return;
        
        let totalBase = 0;
        let totalOvertime = 0;
        
        const mode = document.querySelector('input[name="submissionType"]:checked').value;
        
        // Calculate time entries pay
        if (mode === 'time_and_expenses') {
            timeEntries.forEach(entry => {
                let entryBase = 0;
                let entryOT = 0;
                
                if (currentVendor.payType === 'hourly') {
                    const result = calculateHourlyPayForEntry(entry);
                    entryBase = result.basePay;
                    entryOT = result.overtimePay;
                } else if (currentVendor.payType === 'daily') {
                    entryBase = entry.dayType === 'full' ? currentVendor.fullDayRate : 
                               entry.dayType === 'half' ? currentVendor.halfDayRate : 0;
                } else if (currentVendor.payType === 'routine') {
                    entryBase = (entry.routineCount || 0) * currentVendor.perRoutineRate;
                } else if (currentVendor.payType === 'fixed') {
                    entryBase = currentVendor.fixedAmount || 0;
                }
                
                entry.basePay = entryBase;
                entry.overtimePay = entryOT;
                totalBase += entryBase;
                totalOvertime += entryOT;
            });
            
            renderTimeEntries(); // Update displays in cards
        }
        
        // Calculate mileage and expenses
        const mileageTotal = mileageEntries.reduce((sum, e) => sum + (e.miles * 0.67), 0);
        const expensesTotal = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
        const grandTotal = totalBase + totalOvertime + mileageTotal + expensesTotal;
        
        // Update time entries total display
        const timeTotal = document.getElementById('timeEntriesTotal');
        if (timeTotal) {
            timeTotal.textContent = `$${(totalBase + totalOvertime).toFixed(2)}`;
        }
        
        // Update payment calculation box
        const calcBase = document.getElementById('calcBasePay');
        const calcOT = document.getElementById('calcOvertimePay');
        const calcOTRow = document.getElementById('calcOvertimeRow');
        const calcMileage = document.getElementById('calcMileage');
        const calcExpenses = document.getElementById('calcExpenses');
        const calcTotal = document.getElementById('calcTotal');
        
        if (calcBase) calcBase.textContent = `$${totalBase.toFixed(2)}`;
        if (calcOT) calcOT.textContent = `$${totalOvertime.toFixed(2)}`;
        if (calcOTRow) calcOTRow.style.display = totalOvertime > 0 ? 'flex' : 'none';
        if (calcMileage) calcMileage.textContent = `$${mileageTotal.toFixed(2)}`;
        if (calcExpenses) calcExpenses.textContent = `$${expensesTotal.toFixed(2)}`;
        if (calcTotal) calcTotal.textContent = `$${grandTotal.toFixed(2)}`;
    };

    // V3: Initialize first time entry after vendor loads
    // This will be called by the actual loadVendor function

let uploadedFiles = [];

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('eventDate').valueAsDate = new Date();
    setupCalculationListeners();
    loadVendors();
    
    // Add initial entries
    addMileageEntry();
    addExpenseEntry();
});

async function loadVendors() {
    try {
        const response = await fetch(`${WEBAPP_URL}?action=getVendors`);
        const data = await response.json();
        vendorsList = data.vendors;
        console.log('Vendors loaded:', vendorsList.length);
    } catch (error) {
        console.error('Error loading vendors:', error);
        showAlert('error', 'Failed to load vendor data. Please refresh or contact office@wctedance.com');
    }
}

async function loginVendor() {
    const email = document.getElementById('vendorEmail').value.trim().toLowerCase();
    if (!email) {
        showAlert('warning', 'Please enter your email address.');
        return;
    }
    
    document.getElementById('loadingLogin').style.display = 'block';
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const vendor = vendorsList.find(v => v.email.toLowerCase() === email);
    document.getElementById('loadingLogin').style.display = 'none';
    
    if (vendor) {
        currentVendor = vendor;
        showTimeEntryForm();
    } else {
        showAlert('error', 'Email not found. Please contact office@wctedance.com');
    }
}

function logout() {
    currentVendor = null;
    document.getElementById('timeEntryForm').reset();
    document.getElementById('eventDate').valueAsDate = new Date();
    mileageEntries = [];
    expenseEntries = [];
    uploadedFiles = [];
    hideAllAlerts();
    showSection('sectionLogin');
}

function showTimeEntryForm() {
    document.getElementById('displayName').textContent = `${currentVendor.firstName} ${currentVendor.lastName}`;
    document.getElementById('displayPayType').textContent = getPayTypeDisplay(currentVendor.payType);
    document.getElementById('displayRate').textContent = getRateDisplay(currentVendor);
    
    hideAllTimeEntryFields();
    
    // V3: Old single-entry fields don't exist anymore, skip these
    // The time entry fields are now dynamically generated in renderTimeEntries()
    
    showSection('sectionTimeEntry');
    
    // V3: Initialize first time entry when form loads
    if (timeEntries.length === 0) {
        addTimeEntry();
    }
    
    calculatePayment();
}

function hideAllTimeEntryFields() {
    document.querySelectorAll('.time-entry-fields').forEach(el => {
        el.classList.remove('show');
    });
}

function getPayTypeDisplay(type) {
    const types = {'hourly': 'Hourly Rate', 'daily': 'Daily Rate', 'routine': 'Per-Routine', 'fixed': 'Fixed Amount'};
    return types[type] || type;
}

function getRateDisplay(vendor) {
    switch(vendor.payType) {
        case 'hourly':
            return `$${vendor.hourlyRate}/hr${vendor.overtimeEligible ? ' (OT after ' + vendor.overtimeThreshold + ' hrs)' : ''}`;
        case 'daily':
            return `Full: $${vendor.fullDayRate} | Half: $${vendor.halfDayRate}`;
        case 'routine':
            return `$${vendor.perRoutineRate}/routine`;
        case 'fixed':
            return `$${vendor.fixedAmount} per event`;
        default:
            return 'N/A';
    }
}

// NEW: Mileage Entry Management
function addMileageEntry() {
    const id = Date.now();
    mileageEntries.push({ id, date: '', miles: 0 });
    renderMileageEntries();
    calculatePayment();
}

function removeMileageEntry(id) {
    mileageEntries = mileageEntries.filter(e => e.id !== id);
    renderMileageEntries();
    calculatePayment();
}

function renderMileageEntries() {
    const container = document.getElementById('mileageEntries');
    container.innerHTML = mileageEntries.map((entry, index) => `
        <div class="expense-entry">
            <div class="expense-entry-header">
                <strong>Trip ${index + 1}</strong>
                ${mileageEntries.length > 1 ? `<button type="button" class="btn btn-remove" onclick="removeMileageEntry(${entry.id})">Remove</button>` : ''}
            </div>
            <div class="two-col">
                <div>
                    <label>Date</label>
                    <input type="date" value="${entry.date}" onchange="updateMileageEntry(${entry.id}, 'date', this.value)">
                </div>
                <div>
                    <label>Miles</label>
                    <input type="number" step="0.1" min="0" value="${entry.miles}" onchange="updateMileageEntry(${entry.id}, 'miles', this.value)" placeholder="0.0">
                </div>
            </div>
            <p class="helper-text">Reimbursement: $${(entry.miles * 0.67).toFixed(2)}</p>
        </div>
    `).join('');
}

function updateMileageEntry(id, field, value) {
    const entry = mileageEntries.find(e => e.id === id);
    if (entry) {
        entry[field] = field === 'miles' ? parseFloat(value) || 0 : value;
        renderMileageEntries();
        calculatePayment();
    }
}

// NEW: General Expense Entry Management
function addExpenseEntry() {
    const id = Date.now();
    expenseEntries.push({ id, date: '', amount: 0, description: '' });
    renderExpenseEntries();
    calculatePayment();
}

function removeExpenseEntry(id) {
    expenseEntries = expenseEntries.filter(e => e.id !== id);
    renderExpenseEntries();
    calculatePayment();
}

function renderExpenseEntries() {
    const container = document.getElementById('expenseEntries');
    container.innerHTML = expenseEntries.map((entry, index) => `
        <div class="expense-entry">
            <div class="expense-entry-header">
                <strong>Expense ${index + 1}</strong>
                ${expenseEntries.length > 1 ? `<button type="button" class="btn btn-remove" onclick="removeExpenseEntry(${entry.id})">Remove</button>` : ''}
            </div>
            <div class="two-col">
                <div>
                    <label>Date</label>
                    <input type="date" value="${entry.date}" onchange="updateExpenseEntry(${entry.id}, 'date', this.value)">
                </div>
                <div>
                    <label>Amount</label>
                    <input type="number" step="0.01" min="0" value="${entry.amount}" onchange="updateExpenseEntry(${entry.id}, 'amount', this.value)" placeholder="0.00">
                </div>
            </div>
            <div>
                <label>Description</label>
                <input type="text" value="${entry.description}" onchange="updateExpenseEntry(${entry.id}, 'description', this.value)" placeholder="e.g., Hotel, Meals, Parking">
            </div>
        </div>
    `).join('');
}

function updateExpenseEntry(id, field, value) {
    const entry = expenseEntries.find(e => e.id === id);
    if (entry) {
        entry[field] = field === 'amount' ? parseFloat(value) || 0 : value;
        renderExpenseEntries();
        calculatePayment();
    }
}

// NEW: File Upload Handling
function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    
    files.forEach(file => {
        if (file.size > 5 * 1024 * 1024) {
            showAlert('warning', `File "${file.name}" is too large. Maximum 5MB per file.`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedFiles.push({
                name: file.name,
                size: file.size,
                type: file.type,
                data: e.target.result
            });
            renderUploadedFiles();
        };
        reader.readAsDataURL(file);
    });
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    renderUploadedFiles();
}

function renderUploadedFiles() {
    const container = document.getElementById('uploadedFiles');
    if (uploadedFiles.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-item">
            <span class="file-item-name">ðŸ“„ ${file.name}</span>
            <span class="file-item-size">${(file.size / 1024).toFixed(1)} KB</span>
            <button type="button" class="btn btn-remove" onclick="removeFile(${index})">Remove</button>
        </div>
    `).join('');
}

function setupCalculationListeners() {
    ['clockIn', 'clockOut', 'breakMinutes', 'dayType', 'routineCount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener(el.type === 'number' ? 'input' : 'change', calculatePayment);
    });
}

function calculatePayment() {
    if (!currentVendor) return;
    
    let basePay = 0, overtimePay = 0;
    
    switch(currentVendor.payType) {
        case 'hourly':
            const result = calculateHourlyPay();
            basePay = result.basePay;
            overtimePay = result.overtimePay;
            document.getElementById('hoursWorked').value = (result.regularHours + result.overtimeHours).toFixed(2) + ' hours';
            break;
        case 'daily':
            basePay = calculateDailyPay();
            break;
        case 'routine':
            basePay = calculateRoutinePay();
            break;
        case 'fixed':
            basePay = currentVendor.fixedAmount;
            break;
    }
    
    const mileageTotal = mileageEntries.reduce((sum, e) => sum + (e.miles * 0.67), 0);
    const expensesTotal = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
    
    document.getElementById('calcBasePay').textContent = `$${basePay.toFixed(2)}`;
    
    if (overtimePay > 0) {
        document.getElementById('calcOvertimeRow').style.display = 'flex';
        document.getElementById('calcOvertimePay').textContent = `$${overtimePay.toFixed(2)}`;
    } else {
        document.getElementById('calcOvertimeRow').style.display = 'none';
    }
    
    document.getElementById('calcMileage').textContent = `$${mileageTotal.toFixed(2)}`;
    document.getElementById('calcExpenses').textContent = `$${expensesTotal.toFixed(2)}`;
    document.getElementById('calcTotal').textContent = `$${(basePay + overtimePay + mileageTotal + expensesTotal).toFixed(2)}`;
}

function calculateHourlyPay() {
    // V3: This function is deprecated - kept for compatibility
    const clockInEl = document.getElementById('clockIn');
    const clockOutEl = document.getElementById('clockOut');
    const breakMinutesEl = document.getElementById('breakMinutes');
    
    if (!clockInEl || !clockOutEl) return { basePay: 0, overtimePay: 0, regularHours: 0, overtimeHours: 0 };
    
    const clockIn = clockInEl.value;
    const clockOut = clockOutEl.value;
    const breakMinutes = breakMinutesEl ? (parseFloat(breakMinutesEl.value) || 0) : 0;
    
    if (!clockIn || !clockOut) return { basePay: 0, overtimePay: 0, regularHours: 0, overtimeHours: 0 };
    
    const start = new Date(`2000-01-01T${clockIn}`);
    const end = new Date(`2000-01-01T${clockOut}`);
    let totalMinutes = (end - start) / (1000 * 60);
    if (totalMinutes < 0) totalMinutes += 24 * 60;
    totalMinutes -= breakMinutes;
    const totalHours = Math.max(0, totalMinutes / 60);
    
    let regularHours = totalHours, overtimeHours = 0, basePay = 0, overtimePay = 0;
    
    if (currentVendor.overtimeEligible && totalHours > currentVendor.overtimeThreshold) {
        regularHours = currentVendor.overtimeThreshold;
        overtimeHours = totalHours - currentVendor.overtimeThreshold;
        basePay = regularHours * currentVendor.hourlyRate;
        overtimePay = overtimeHours * currentVendor.hourlyRate * currentVendor.overtimeMultiplier;
    } else {
        basePay = totalHours * currentVendor.hourlyRate;
    }
    
    return { basePay, overtimePay, regularHours, overtimeHours };
}

function calculateDailyPay() {
    // V3: This function is deprecated - kept for compatibility
    const dayTypeEl = document.getElementById('dayType');
    if (!dayTypeEl) return 0;
    const dayType = dayTypeEl.value;
    return dayType === 'full' ? currentVendor.fullDayRate : dayType === 'half' ? currentVendor.halfDayRate : 0;
}

function calculateRoutinePay() {
    // V3: This function is deprecated - kept for compatibility
    const routineCountEl = document.getElementById('routineCount');
    if (!routineCountEl) return 0;
    const routineCount = parseFloat(routineCountEl.value) || 0;
    return routineCount * currentVendor.perRoutineRate;
}

document.getElementById('timeEntryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentVendor) {
        showAlert('error', 'Session expired. Please log in again.');
        logout();
        return;
    }
    
    if (!document.getElementById('acknowledge').checked) {
        showAlert('warning', 'Please acknowledge that all information is correct.');
        return;
    }
    
    document.getElementById('loadingSubmit').style.display = 'block';
    hideAllAlerts();
    
    try {
        // V3: Use collectV3FormData to include time entries array
        const formData = collectV3FormData();
        const result = await submitToWebApp(formData);
        await sendEmailNotifications(formData, result);
        
        document.getElementById('loadingSubmit').style.display = 'none';
        
        let successMsg = 'Time entry submitted successfully! You will receive a confirmation email at ' + formData.vendorEmail;
        if (result.driveFolder) {
            successMsg += '\n\nReceipts uploaded to: ' + result.driveFolder;
        }
        showAlert('success', successMsg);
        
        // V3: Complete form cleanup after successful submission
        setTimeout(() => {
            // Reset form fields
            document.getElementById('timeEntryForm').reset();
            document.getElementById('eventDate').valueAsDate = new Date();
            
            // V3: Clear time entries array and re-initialize
            timeEntries = [];
            addTimeEntry(); // Add fresh first entry
            
            // Clear mileage and expenses
            mileageEntries = [];
            expenseEntries = [];
            addMileageEntry();
            addExpenseEntry();
            
            // V3: Clear uploaded files and file display
            uploadedFiles = [];
            const fileInput = document.getElementById('receiptFiles');
            if (fileInput) {
                fileInput.value = ''; // Clear file input
            }
            const fileList = document.getElementById('fileList');
            if (fileList) {
                fileList.innerHTML = '<p style="color: #6c757d; font-style: italic;">No files selected</p>';
            }
            const driveStatus = document.getElementById('driveUploadStatus');
            if (driveStatus) {
                driveStatus.innerHTML = '';
            }
            
            // Reset submission type to default
            const timeAndExpensesRadio = document.querySelector('input[name="submissionType"][value="time_and_expenses"]');
            if (timeAndExpensesRadio) {
                timeAndExpensesRadio.checked = true;
                toggleFormMode(); // Show time section
            }
            
            // Recalculate payment (should be $0.00)
            calculatePayment();
            
            // Hide alerts
            hideAllAlerts();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 3000);
        
    } catch (error) {
        document.getElementById('loadingSubmit').style.display = 'none';
        console.error('Submission error:', error);
        showAlert('error', 'Failed to submit. Please try again or contact office@wctedance.com');
    }
});

function collectFormData() {
    const form = document.getElementById('timeEntryForm');
    const formData = new FormData(form);
    
    let basePay = 0, overtimePay = 0, details = '';
    
    switch(currentVendor.payType) {
        case 'hourly':
            const hourlyResult = calculateHourlyPay();
            basePay = hourlyResult.basePay;
            overtimePay = hourlyResult.overtimePay;
            details = `Hours: ${(hourlyResult.regularHours + hourlyResult.overtimeHours).toFixed(2)}`;
            break;
        case 'daily':
            basePay = calculateDailyPay();
            details = `Day Type: ${formData.get('dayType')}`;
            break;
        case 'routine':
            basePay = calculateRoutinePay();
            details = `Routines: ${formData.get('routineCount')}`;
            break;
        case 'fixed':
            basePay = currentVendor.fixedAmount;
            details = 'Fixed Amount';
            break;
    }
    
    const mileageTotal = mileageEntries.reduce((sum, e) => sum + (e.miles * 0.67), 0);
    const expensesTotal = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
    const totalPay = basePay + overtimePay + mileageTotal + expensesTotal;
    
    return {
        vendorId: currentVendor.id,
        vendorName: `${currentVendor.firstName} ${currentVendor.lastName}`,
        vendorEmail: currentVendor.email,
        payType: currentVendor.payType,
        eventDate: formData.get('eventDate'),
        eventName: formData.get('eventName'),
        eventLocation: formData.get('eventLocation'),
        rolePerformed: formData.get('rolePerformed'),
        workDetails: details,
        clockIn: formData.get('clockIn') || 'N/A',
        clockOut: formData.get('clockOut') || 'N/A',
        breakMinutes: formData.get('breakMinutes') || '0',
        dayType: formData.get('dayType') || 'N/A',
        routineCount: formData.get('routineCount') || '0',
        mileageEntries: JSON.stringify(mileageEntries),
        mileageTotal: mileageTotal.toFixed(2),
        expenseEntries: JSON.stringify(expenseEntries),
        expensesTotal: expensesTotal.toFixed(2),
        receipts: JSON.stringify(uploadedFiles.map(f => ({ name: f.name, size: f.size, type: f.type }))),
        receiptFiles: uploadedFiles.length > 0 ? JSON.stringify(uploadedFiles) : '',
        basePay: basePay.toFixed(2),
        overtimePay: overtimePay.toFixed(2),
        totalPay: totalPay.toFixed(2),
        additionalNotes: formData.get('additionalNotes') || '',
        submissionDate: new Date().toISOString(),
        status: 'Pending Review'
    };
}


    // V3: Collect form data with time entries
    function collectV3FormData() {
        const mode = document.querySelector('input[name="submissionType"]:checked').value;
        const timeEntriesTotal = timeEntries.reduce((sum, e) => sum + e.basePay + e.overtimePay, 0);
        const mileageTotal = mileageEntries.reduce((sum, e) => sum + (e.miles * 0.67), 0);
        const expensesTotal = expenseEntries.reduce((sum, e) => sum + e.amount, 0);
        const totalPay = timeEntriesTotal + mileageTotal + expensesTotal;
        
        const eventDateField = document.getElementById('eventDate');
        const eventNameField = document.getElementById('eventName');
        const eventLocationField = document.getElementById('eventLocation');
        const rolePerformedField = document.getElementById('rolePerformed');
        const notesField = document.getElementById('additionalNotes');
        
        // Get first time entry for legacy fields (if exists)
        const firstEntry = timeEntries.length > 0 ? timeEntries[0] : null;
        
        return {
            submissionType: mode,
            vendorId: currentVendor.id,
            vendorName: `${currentVendor.firstName} ${currentVendor.lastName}`,
            vendorEmail: currentVendor.email,
            payType: currentVendor.payType,
            eventDate: eventDateField ? eventDateField.value : '',
            eventName: eventNameField ? eventNameField.value : '',
            eventLocation: eventLocationField ? eventLocationField.value : '',
            rolePerformed: rolePerformedField ? rolePerformedField.value : '',
            
            // Legacy fields (for backward compatibility - uses first time entry or defaults)
            workDetails: firstEntry ? firstEntry.workDetails : '',
            clockIn: firstEntry ? firstEntry.clockIn : '',
            clockOut: firstEntry ? firstEntry.clockOut : '',
            breakMinutes: firstEntry ? firstEntry.breakMinutes : 0,
            dayType: firstEntry ? firstEntry.dayType : '',
            routineCount: firstEntry ? firstEntry.routineCount : 0,
            basePay: firstEntry ? firstEntry.basePay.toFixed(2) : '0.00',
            overtimePay: firstEntry ? firstEntry.overtimePay.toFixed(2) : '0.00',
            
            // V3: Time entries array
            timeEntries: JSON.stringify(timeEntries),
            timeEntriesTotal: timeEntriesTotal.toFixed(2),
            
            // Existing fields
            mileageEntries: JSON.stringify(mileageEntries),
            mileageTotal: mileageTotal.toFixed(2),
            expenseEntries: JSON.stringify(expenseEntries),
            expensesTotal: expensesTotal.toFixed(2),
            receipts: JSON.stringify(uploadedFiles.map(f => ({ name: f.name, size: f.size, type: f.type }))),
            receiptFiles: uploadedFiles.length > 0 ? JSON.stringify(uploadedFiles) : '',
            totalPay: totalPay.toFixed(2),
            additionalNotes: notesField ? notesField.value : '',
            submissionDate: new Date().toISOString(),
            status: 'Pending Review'
        };
    }

    async function submitToWebApp(data) {
    const response = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain'},
        body: JSON.stringify({action: 'submitTimeEntry', data: data})
    });
    
    if (!response.ok) throw new Error('Failed to submit');
    return await response.json();
}

async function sendEmailNotifications(data, result) {
    // Format mileage details for email
    const mileageDetails = mileageEntries.length > 0 
        ? mileageEntries.map((e, i) => 
            `${e.date || 'No date'}: ${e.from || ''} to ${e.to || ''} - ${e.miles} miles ($${(e.miles * 0.67).toFixed(2)})`
          ).join('<br>')
        : 'No mileage entries';
    
    // Format expense details for email
    const expenseDetails = expenseEntries.length > 0
        ? expenseEntries.map((e, i) => 
            `${e.date || 'No date'}: ${e.description || 'No description'} - $${e.amount.toFixed(2)}`
          ).join('<br>')
        : 'No expense entries';
    
    // Format receipt info
    const receiptInfo = uploadedFiles.length > 0
        ? `${uploadedFiles.length} receipt(s) attached`
        : 'No receipts attached';
    
    // Calculate hours from time entries (V3) or single entry
    let totalHours = 0;
    let regularHours = 0;
    let overtimeHours = 0;
    let dailyBreakdown = '';
    
    if (data.timeEntries && data.timeEntries !== '[]') {
        // V3: Multiple time entries
        const entries = JSON.parse(data.timeEntries);
        dailyBreakdown = entries.map((entry, i) => {
            const hours = parseFloat(entry.hours || 0);
            const regHrs = Math.min(hours, currentVendor.overtimeThreshold || 8);
            const otHrs = Math.max(0, hours - (currentVendor.overtimeThreshold || 8));
            
            totalHours += hours;
            regularHours += regHrs;
            overtimeHours += otHrs;
            
            return `<strong>Day ${i + 1} (${entry.date || 'No date'}):</strong><br>` +
                   `${entry.clockIn || 'N/A'} - ${entry.clockOut || 'N/A'}<br>` +
                   `${entry.rolePerformed || 'No role'} - ${hours.toFixed(2)} hrs<br>` +
                   `Base: $${entry.basePay || '0.00'}, OT: $${entry.overtimePay || '0.00'}`;
        }).join('<br><br>');
    } else {
        // Legacy: Single time entry
        if (data.clockIn && data.clockOut && data.clockIn !== 'N/A' && data.clockOut !== 'N/A') {
            const clockIn = new Date(`1970-01-01T${data.clockIn}`);
            const clockOut = new Date(`1970-01-01T${data.clockOut}`);
            const breakMins = parseInt(data.breakMinutes) || 0;
            const diffMs = clockOut - clockIn;
            const hours = (diffMs / (1000 * 60 * 60)) - (breakMins / 60);
            
            totalHours = Math.max(0, hours);
            regularHours = Math.min(totalHours, currentVendor.overtimeThreshold || 8);
            overtimeHours = Math.max(0, totalHours - (currentVendor.overtimeThreshold || 8));
            
            dailyBreakdown = `<strong>${data.eventDate}:</strong><br>` +
                           `${data.clockIn} - ${data.clockOut} (${breakMins} min break)<br>` +
                           `${data.rolePerformed || 'No role'} - ${totalHours.toFixed(2)} hrs<br>` +
                           `Base: $${data.basePay || '0.00'}, OT: $${data.overtimePay || '0.00'}`;
        } else {
            dailyBreakdown = 'No time entry details provided';
        }
    }
    
    // Determine W-9 status
    const w9Status = currentVendor.w9OnFile ? 'On File' : 'Not Submitted';
    const w9StatusIcon = currentVendor.w9OnFile ? '✅' : '⚠️';
    const w9BgColor = currentVendor.w9OnFile ? '#e8f5e9' : '#fff3e0';
    const w9BorderColor = currentVendor.w9OnFile ? '#c8e6c9' : '#ffe0b2';
    const w9TextColor = currentVendor.w9OnFile ? '#2e7d32' : '#e65100';
    
    // Format submission timestamp
    const submissionTimestamp = new Date().toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
    
    // Create pay period string
    const payPeriod = `${data.eventDate} - ${data.eventName}`;
    
    // Calculate payment totals
    const timeEntryPay = (parseFloat(data.basePay || 0) + parseFloat(data.overtimePay || 0)).toFixed(2);
    const mileageTotal = parseFloat(data.mileageTotal || 0).toFixed(2);
    const expensesTotal = parseFloat(data.expensesTotal || 0).toFixed(2);
    const grandTotal = parseFloat(data.totalPay || 0).toFixed(2);
    
    // Determine submission type
    const submissionType = data.submissionType === 'expenses_only' ? 'EXPENSE REPORT ONLY' : 'TIME ENTRY + EXPENSES';
    
    // Get confirmation number from result
    const confirmationNumber = result && result.entryId ? result.entryId : 'Processing...';
    
    // Send office notification with all template variables
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_OFFICE, {
        // Vendor information
        vendor_name: data.vendorName,
        vendor_email: data.vendorEmail,
        submission_timestamp: submissionTimestamp,
        
        // Time entry details
        pay_period: payPeriod,
        total_hours: totalHours.toFixed(2),
        regular_hours: regularHours.toFixed(2),
        overtime_hours: overtimeHours.toFixed(2),
        
        // Daily breakdown
        daily_breakdown: dailyBreakdown,
        
        // Payment summary
        time_entry_pay: `$${timeEntryPay}`,
        mileage_total: `$${mileageTotal}`,
        expenses_total: `$${expensesTotal}`,
        grand_total: `$${grandTotal}`,
        
        // Mileage & expenses
        mileage_details: mileageDetails,
        expense_details: expenseDetails,
        receipt_info: receiptInfo,
        
        // W-9 status
        w9_status: w9Status,
        w9_status_icon: w9StatusIcon,
        w9_bg_color: w9BgColor,
        w9_border_color: w9BorderColor,
        w9_text_color: w9TextColor,
        
        // Additional info
        vendor_notes: data.additionalNotes || 'No additional notes',
        admin_portal_url: window.location.origin + '/admin-V3-COMPLETE.html',
        submission_type: submissionType
    });
    
    // Send vendor confirmation email with all required fields
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CONFIRMATION, {
        to_email: data.vendorEmail,
        vendor_name: data.vendorName,
        submission_type: submissionType,
        pay_period: payPeriod,
        submission_timestamp: submissionTimestamp,
        confirmation_number: confirmationNumber,
        time_entry_pay: `$${timeEntryPay}`,
        mileage_total: `$${mileageTotal}`,
        expenses_total: `$${expensesTotal}`,
        grand_total: `$${grandTotal}`,
        current_year: new Date().getFullYear()
    });
}

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
}

function showAlert(type, message) {
    hideAllAlerts();
    const alertId = type === 'success' ? 'alertSuccess' : type === 'error' ? 'alertError' : 'alertWarning';
    const alertEl = document.getElementById(alertId);
    alertEl.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
    alertEl.classList.add('show');
    alertEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideAllAlerts() {
    document.querySelectorAll('.alert').forEach(alert => alert.classList.remove('show'));
}
    </script>
</body>
</html>
